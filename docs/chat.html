<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Zethra • Chat (Web)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--accent:#7C3AED;--bg:#fff;--card:#F3F4F6;--text:#111827;--mid:#6B7280;--border:#E5E7EB}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .shell{display:flex;flex-direction:column;height:100vh}
    .header{height:56px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:center;background:var(--bg)}
    .header h1{font-size:16px;margin:0;font-weight:800}
    .list{flex:1;overflow:auto;padding:12px 14px 90px 14px} /* 90px for composer */
    .bubble{max-width:85%;padding:12px;border-radius:16px;margin:4px 0;white-space:pre-wrap;line-height:1.4}
    .user{margin-left:auto;background:var(--accent);color:#fff}
    .bot{margin-right:auto;background:var(--card);border:1px solid var(--border)}
    .meta{font-size:12px;color:var(--mid);margin:0 0 6px 2px}
    .composer{position:fixed;left:0;right:0;bottom:0;background:var(--bg);border-top:1px solid var(--border);padding:10px}
    .row{display:flex;gap:8px;align-items:flex-end;max-width:900px;margin:0 auto}
    textarea{flex:1;border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#fff;color:var(--text);min-height:44px;max-height:140px}
    button{width:52px;height:52px;border:0;border-radius:12px;background:var(--accent);color:#fff;font-weight:800;display:flex;align-items:center;justify-content:center;cursor:pointer}
    button:disabled{background:#C4B5FD;cursor:default}
    .warn{font-size:12px;color:var(--mid);max-width:900px;margin:6px auto 0 auto;padding:0 2px}
    .skel{width:60%;height:10px;border-radius:8px;background:#E5E7EB;animation:glisten 1.6s ease-in-out infinite alternate}
    @keyframes glisten{from{opacity:.35}to{opacity:1}}
  </style>
</head>
<body>
  <div class="shell">
    <div class="header"><h1>Zethra</h1></div>
    <div id="list" class="list"></div>

    <div class="composer">
      <div class="row">
        <textarea id="input" placeholder="Type your message…"></textarea>
        <button id="send" title="Send" aria-label="Send">↑</button>
      </div>
      <div class="warn">Zethra is not therapy and may be wrong. If you’re in crisis, seek immediate help.</div>
    </div>
  </div>

  <script>
    // ---- Config: Voiceflow (from your app) ----
    const VF_API_KEY = "VF.DM.68cdc045b265f986867848b6.dl6hm78M1vO2p8Y3";
    const VF_VERSION_ID = "68c8d9b793774c6ce4873579";

    // ---- Session key (per-browser) ----
    const KEY = "zethra_web_uid";
    let userKey = localStorage.getItem(KEY);
    if (!userKey) {
      userKey = "web-" + Date.now() + "-" + Math.random().toString(36).slice(2, 8);
      localStorage.setItem(KEY, userKey);
    }

    const list = document.getElementById("list");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");

    function vfURL() {
      return `https://general-runtime.voiceflow.com/state/user/${encodeURIComponent(userKey)}/interact?versionID=${encodeURIComponent(VF_VERSION_ID)}`;
    }

    function addBubble(role, text, isSkeleton=false) {
      const wrap = document.createElement("div");
      if (role === "assistant") {
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = "Zethra";
        list.appendChild(meta);
      }
      const b = document.createElement("div");
      b.className = "bubble " + (role === "user" ? "user" : "bot");
      if (isSkeleton) {
        const s = document.createElement("div");
        s.className = "skel";
        b.appendChild(s);
      } else {
        b.textContent = text;
      }
      wrap.appendChild(b);
      list.appendChild(wrap);
      list.scrollTop = list.scrollHeight;
      return wrap;
    }

    function extractTexts(traces) {
      const out = [];
      for (const t of traces || []) {
        if (t.type === "text" && t.payload?.message) out.push(String(t.payload.message));
        if (t.type === "speak" && t.payload?.message) out.push(String(t.payload.message));
        if (t.type === "visual") {
          const p = t.payload || {};
          if (p.title) out.push(String(p.title));
          if (p.text) out.push(String(p.text));
          if (Array.isArray(p.cards)) {
            p.cards.forEach(c => {
              if (c?.title) out.push(String(c.title));
              if (c?.description) out.push(String(c.description));
            });
          }
        }
      }
      return out;
    }

    async function vfRequest(action) {
      const res = await fetch(vfURL(), {
        method: "POST",
        headers: {
          Authorization: VF_API_KEY,
          Accept: "application/json",
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ action, config: { tts: false, stripSSML: true, stopAll: true } }),
      });
      if (!res.ok) throw new Error("Voiceflow " + res.status);
      return res.json();
    }

    let launched = false;

    async function send() {
      const text = input.value.trim();
      if (!text) return;
      input.value = "";

      addBubble("user", text);
      const loader = addBubble("assistant", "", true);

      try {
        if (!launched) {
          const traces0 = await vfRequest({ type: "launch" });
          const texts0 = extractTexts(traces0);
          if (texts0.length) {
            loader.remove();
            texts0.forEach(t => addBubble("assistant", t));
          }
          launched = true;
        }

        const traces = await vfRequest({ type: "text", payload: text });
        const texts = extractTexts(traces);
        loader.remove();
        (texts.length ? texts : ["(no visible text)"]).forEach(t => addBubble("assistant", t));
      } catch (e) {
        loader.remove();
        addBubble("assistant", "Error: " + (e.message || e));
      }
    }

    sendBtn.addEventListener("click", send);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });
  </script>
</body>
</html>
